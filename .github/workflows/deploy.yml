name: Deploy XLSVC Flask Backend

on:
  workflow_run:
    workflows: ["Test Suite - Backend"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if tests passed (workflow_run with conclusion success)
    # OR if manually triggered (workflow_dispatch)
    if: |
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push') ||
      github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # When triggered by workflow_run, checkout the commit that triggered the test workflow
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

      - name: Backup existing files
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            cd ${{ secrets.DEPLOY_PATH }}/api/xlsvc

            # Create backup directory with timestamp
            backup_dir="backup_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$backup_dir"

            # Backup Python files, requirements, and config files
            cp *.py requirements.txt .htaccess passenger_wsgi.py "$backup_dir/" 2>/dev/null || echo "Some files not found for backup"

            echo "Backup created in $backup_dir"

      - name: Upload Flask Backend Files
        run: |
          # Use rsync to upload Python files
          rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            --include="*.py" \
            --include="requirements.txt" \
            --exclude="*" \
            ./ ${{ secrets.USERNAME }}@${{ secrets.HOST }}:${{ secrets.DEPLOY_PATH }}/api/xlsvc/

      - name: Install Dependencies and Setup
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_APP_ID: ${{ secrets.APP_ID }}
          GITHUB_INSTALLATION_ID: ${{ secrets.INSTALLATION_ID }}
          GITHUB_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GITHUB_APP_ID,GITHUB_INSTALLATION_ID,GITHUB_PRIVATE_KEY
          script: |
            set -euo pipefail

            cd ${{ secrets.DEPLOY_PATH }}/api/xlsvc

            # Activate virtual environment
            source ${{ secrets.PASSENGER_PYTHON_PATH }}/bin/activate

            # Update pip and install dependencies
            pip install --upgrade pip
            pip install -r requirements.txt

            # Create/update passenger_wsgi.py
            cat > passenger_wsgi.py << 'WSGI_EOF'
            import os
            import sys
            sys.path.insert(0, os.path.dirname(__file__))
            from main import app as application
            WSGI_EOF

            # Create directories
            mkdir -p uploads tmp macros processed
            chmod 755 uploads macros processed

            # Initialize database if it doesn't exist
            if [ ! -f xlsvc.db ]; then
              python -c "from main import init_db; init_db()" || echo "Database init skipped - no init_db function"
            fi

            # Create/update .htaccess
            cat > .htaccess << 'HTACCESS_EOF'
            RewriteEngine Off
            Options -MultiViews
            PassengerEnabled on
            PassengerAppRoot ${{ secrets.PASSENGER_APP_ROOT }}
            PassengerAppType wsgi
            PassengerStartupFile passenger_wsgi.py
            PassengerBaseURI /
            PassengerPython ${{ secrets.PASSENGER_PYTHON_PATH }}/bin/python
            ErrorDocument 404 "Not Found"
            ErrorDocument 500 "Server Error"
            HTACCESS_EOF

            # Set permissions
            chmod 644 *.py requirements.txt .htaccess passenger_wsgi.py 2>/dev/null || true
            chmod 755 uploads macros processed
            chmod 644 xlsvc.db 2>/dev/null || true

            # Restart Passenger
            touch tmp/restart.txt

            echo "Flask backend deployment complete!"

      - name: Setup Cron Job
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            
            # Build the cron command with proper paths
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}/api/xlsvc"
            PYTHON_PATH="${{ secrets.PASSENGER_PYTHON_PATH }}/bin/python"
            CRON_CMD="cd $DEPLOY_PATH && source ${{ secrets.PASSENGER_PYTHON_PATH }}/bin/activate && $PYTHON_PATH cleanup_files.py >> $DEPLOY_PATH/cleanup.log 2>&1"
            CRON_JOB="0 2 * * * $CRON_CMD"
            
            # Get current crontab (if exists) and check if our job is already there
            CURRENT_CRON=$(crontab -l 2>/dev/null || echo "")
            
            if echo "$CURRENT_CRON" | grep -q "cleanup_files.py"; then
              echo "Cron job already exists, skipping setup"
            else
              # Add our cron job to the existing crontab
              (echo "$CURRENT_CRON"; echo "$CRON_JOB") | crontab -
              echo "Cron job added successfully"
            fi

      - name: Verify Deployment
        run: |
          echo "Flask Backend Deployment Complete!"
          echo "API: https://api.xlsvc.jsilverman.ca/api/health"
          echo ""
          echo "Testing API endpoint..."
          sleep 15
          curl -f https://api.xlsvc.jsilverman.ca/api/health || echo "API not responding yet - check logs"

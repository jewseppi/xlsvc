name: Process Excel File

on:
  repository_dispatch:
    types: [process-excel]

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LibreOffice and Python dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice python3-uno python3-pip
          pip3 install openpyxl

      - name: Download input file
        run: |
          echo "Downloading file from: ${{ github.event.client_payload.file_url }}"
          curl -L --max-time 60 --connect-timeout 10 --retry 3 --retry-delay 5 \
            "${{ github.event.client_payload.file_url }}" -o input.xlsx
          if [ ! -f input.xlsx ] || [ ! -s input.xlsx ]; then
            echo "‚ùå Failed to download file or file is empty"
            exit 1
          fi
          ls -la input.xlsx
          echo "‚úÖ File downloaded successfully, size: $(stat -c%s input.xlsx) bytes"

      - name: Start LibreOffice headless
        run: |
          libreoffice --headless --invisible --nocrashreport --nodefault --nofirststartwizard --nologo --norestore --accept="socket,host=localhost,port=2002;urp;" &
          sleep 10

      - name: Process Excel file with UNO
        env:
          FILTER_RULES: ${{ github.event.client_payload.filter_rules }}
        run: |
          python3 process_uno.py > process_output.log 2>&1
          cat process_output.log

      - name: Extract deleted rows count
        id: extract_count
        run: |
          # Extract the deleted rows count from the output
          DELETED_ROWS=$(grep "Deleted" process_output.log | grep -oP '\d+' | head -1)
          echo "deleted_rows=$DELETED_ROWS" >> $GITHUB_OUTPUT
          echo "Deleted rows: $DELETED_ROWS"

      - name: Upload processed file back to server
        if: success()
        run: |
          if [ -f "output.xlsx" ]; then
            echo "‚úÖ Processing successful - uploading to server"
            echo "Output file size: $(stat -c%s output.xlsx) bytes"
            
            # Check if deletion report was generated
            if [ -f "deletion_report.xlsx" ]; then
              echo "üìä Deletion report found, size: $(stat -c%s deletion_report.xlsx) bytes"
              REPORT_FLAG="-F report=@deletion_report.xlsx"
            else
              echo "‚ö†Ô∏è  No deletion report generated"
              REPORT_FLAG=""
            fi
            
            # Upload processed file and report (if it exists)
            curl -X POST \
              -F "job_id=${{ github.event.client_payload.job_id }}" \
              -F "file=@output.xlsx" \
              $REPORT_FLAG \
              -F "deleted_rows=${{ steps.extract_count.outputs.deleted_rows }}" \
              -H "Authorization: Bearer ${{ github.event.client_payload.callback_token }}" \
              "${{ github.event.client_payload.callback_url }}"
            
            echo "Upload complete!"
          else
            echo "‚ùå Processing failed - output.xlsx not found"
            exit 1
          fi

      - name: Notify failure
        if: failure()
        run: |
          # Notify the server that processing failed
          curl -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ github.event.client_payload.callback_token }}" \
            -d "{\"job_id\":\"${{ github.event.client_payload.job_id }}\",\"status\":\"failed\",\"error\":\"GitHub Actions workflow failed\"}" \
            "${{ github.event.client_payload.callback_url }}"

      - name: Upload as GitHub artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: processed-excel-${{ github.event.client_payload.job_id }}
          path: |
            output.xlsx
            process_output.log
          retention-days: 30
          if-no-files-found: warn

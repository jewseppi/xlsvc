name: Process Excel File

on:
  repository_dispatch:
    types: [process-excel]

jobs:
  process:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LibreOffice
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice python3-uno

      - name: Download input file
        run: |
          curl -L "${{ github.event.client_payload.file_url }}" -o input.xlsx
          ls -la input.xlsx

      - name: Start LibreOffice headless
        run: |
          libreoffice --headless --invisible --nocrashreport --nodefault --nofirststartwizard --nologo --norestore --accept="socket,host=localhost,port=2002;urp;" &
          sleep 10

      - name: Process Excel file with UNO
        env:
          FILTER_RULES: ${{ github.event.client_payload.filter_rules }}
        run: python3 process_uno.py

      - name: Upload processed file
        uses: actions/upload-artifact@v4
        with:
          name: processed-excel
          path: output.xlsx
          retention-days: 30

      - name: Show file info
        run: |
          if [ -f "output.xlsx" ]; then
            echo "✅ Processing successful"
            echo "Output file size: $(stat -c%s output.xlsx) bytes"
          else
            echo "✗ Processing failed"
            exit 1
          fi
